<!--pages/index/index.wxml-->
<view class="page">
  <!-- 顶部渐变区域（含banner） -->
  <view class="top-gradient" style="padding-top: {{statusBarHeight}}px;">
    <view class="header">
      <view class="community-select" bindtap="onCommunityTap">
        <text class="community-name">{{currentCommunity}}</text>
        <text class="arrow">▾</text>
      </view>
      <view class="search-bar" bindtap="goSearch">
        <icon name="search" size="32" color="#888"></icon>
        <text class="search-placeholder">搜索闲置好物...</text>
      </view>
    </view>
    <!-- 广告轮播 -->
    <view class="banner-wrap">
      <swiper class="banner-swiper" indicator-dots autoplay interval="4000" circular>
        <swiper-item wx:for="{{banners}}" wx:key="id">
          <image class="banner-img" src="{{item.image}}" mode="aspectFill"></image>
        </swiper-item>
      </swiper>
    </view>
  </view>

  <scroll-view scroll-y class="scroll-content" refresher-enabled="{{true}}" bindrefresherrefresh="onRefresh" refresher-triggered="{{isRefreshing}}">

    <!-- 快捷入口 -->
    <view class="quick-entry">
      <view class="entry-item" bindtap="goForum">
        <view class="entry-icon" style="background:#F5FFD6;">
          <icon name="message-circle" size="44" color="#7A9900"></icon>
        </view>
        <text class="entry-label">楼里事儿</text>
      </view>
      <view class="entry-item" bindtap="goHelp">
        <view class="entry-icon" style="background:#EFFFB8;">
          <icon name="handshake" size="44" color="#7A9900"></icon>
        </view>
        <text class="entry-label">邻里帮忙</text>
      </view>
      <view class="entry-item" bindtap="goRental">
        <view class="entry-icon" style="background:#E8FF9E;">
          <icon name="home" size="44" color="#7A9900"></icon>
        </view>
        <text class="entry-label">房屋租赁</text>
      </view>
      <view class="entry-item" bindtap="goPet">
        <view class="entry-icon" style="background:#F0FFCC;">
          <icon name="paw-print" size="44" color="#7A9900"></icon>
        </view>
        <text class="entry-label">宠物喂养</text>
      </view>
    </view>

    <!-- 内容Tab -->
    <view class="tab-bar-wrap">
      <scroll-view scroll-x class="tab-scroll">
        <view class="tab-list">
          <view class="tab-item {{activeTab === index ? 'active' : ''}}"
                wx:for="{{tabs}}" wx:key="index"
                bindtap="onTabChange" data-index="{{index}}">
            <text>{{item}}</text>
            <view class="tab-line" wx:if="{{activeTab === index}}"></view>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 分类筛选（闲置物品tab下） -->
    <scroll-view scroll-x class="category-scroll" wx:if="{{activeTab === 0}}">
      <view class="category-list">
        <view class="category-item {{activeCategory === item.id ? 'active' : ''}}"
              wx:for="{{categories}}" wx:key="id"
              bindtap="onCategoryChange" data-id="{{item.id}}">
          <icon name="{{item.iconName}}" size="36" color="{{activeCategory === item.id ? '#7A9900' : '#888'}}"></icon>
          <text class="cat-name">{{item.name}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- 商品瀑布流 -->
    <view class="product-grid">
      <view class="grid-column">
        <view class="product-card" wx:for="{{leftProducts}}" wx:key="id" bindtap="goDetail" data-id="{{item.id}}">
          <view class="card-image">
            <image src="{{item.images[0]}}" mode="aspectFill" class="product-img"></image>
            <view class="free-badge" wx:if="{{item.isFree}}">免费</view>
          </view>
          <view class="card-info">
            <text class="product-title line-clamp-2">{{item.title}}</text>
            <view class="price-row">
              <text class="price" wx:if="{{!item.isFree}}">¥{{item.price}}</text>
              <text class="price free-price" wx:else>免费自取</text>
              <text class="original-price" wx:if="{{item.originalPrice > 0 && !item.isFree}}">¥{{item.originalPrice}}</text>
            </view>
            <view class="card-footer">
              <text class="seller-info">{{item.building}}</text>
              <text class="want-count">{{item.wantCount}}人想要</text>
            </view>
          </view>
        </view>
      </view>
      <view class="grid-column">
        <view class="product-card" wx:for="{{rightProducts}}" wx:key="id" bindtap="goDetail" data-id="{{item.id}}">
          <view class="card-image">
            <image src="{{item.images[0]}}" mode="aspectFill" class="product-img"></image>
            <view class="free-badge" wx:if="{{item.isFree}}">免费</view>
          </view>
          <view class="card-info">
            <text class="product-title line-clamp-2">{{item.title}}</text>
            <view class="price-row">
              <text class="price" wx:if="{{!item.isFree}}">¥{{item.price}}</text>
              <text class="price free-price" wx:else>免费自取</text>
              <text class="original-price" wx:if="{{item.originalPrice > 0 && !item.isFree}}">¥{{item.originalPrice}}</text>
            </view>
            <view class="card-footer">
              <text class="seller-info">{{item.building}}</text>
              <text class="want-count">{{item.wantCount}}人想要</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="load-more" wx:if="{{!hasMore}}">— 没有更多了 —</view>
    <view style="height: 160rpx;"></view>
  </scroll-view>
</view>

<!-- 小区选择弹窗 -->
<view class="modal-mask" wx:if="{{showCommunityPicker}}" bindtap="closePicker">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">选择小区</text>
      <view class="modal-close" bindtap="closePicker">
        <icon name="x" size="36" color="#999"></icon>
      </view>
    </view>
    <view class="community-list">
      <view class="community-option {{item.name === currentCommunity ? 'selected' : ''}}"
            wx:for="{{communities}}" wx:key="id"
            bindtap="selectCommunity" data-item="{{item}}">
        <text>{{item.name}}</text>
        <icon wx:if="{{item.name === currentCommunity}}" name="check" size="32" color="#7A9900"></icon>
      </view>
    </view>
  </view>
</view>
