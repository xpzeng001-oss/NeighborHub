<!--pages/index/index.wxml-->
<view class="page">
  <!-- 状态栏占位 -->
  <view style="height: {{statusBarHeight}}px;"></view>

  <!-- 导航栏：小区选择，与胶囊按钮同行 -->
  <view class="nav-header" style="height: {{navHeight}}px;">
    <view class="community-select" bindtap="onCommunityTap">
      <icon name="map-pin" size="32" color="#5B8C3E"></icon>
      <text class="community-name">{{currentCommunity}}</text>
      <icon name="caret-down" size="24" color="#999"></icon>
    </view>
  </view>

  <!-- 搜索栏 -->
  <view class="search-header">
    <view class="search-input" bindtap="goSearch">
      <icon name="search" size="32" color="#AAAAAA"></icon>
      <text class="search-placeholder">搜索闲置物品、服务、求助...</text>
    </view>
  </view>

  <scroll-view scroll-y class="scroll-content" refresher-enabled="{{true}}" bindrefresherrefresh="onRefresh" refresher-triggered="{{isRefreshing}}">

    <!-- Banner -->
    <image class="banner-img" src="/images/banner-home.jpg" mode="aspectFill"></image>

    <!-- 分类胶囊 -->
    <scroll-view scroll-x class="type-scroll" enhanced show-scrollbar="{{false}}">
      <view class="type-list">
        <view class="type-pill {{activeType === item.id ? 'active' : ''}}"
              wx:for="{{contentTypes}}" wx:key="id"
              bindtap="onTypeChange" data-id="{{item.id}}">
          <icon name="{{item.icon}}" size="28" color="{{activeType === item.id ? '#fff' : item.color}}"></icon>
          <text>{{item.name}}</text>
        </view>
      </view>
    </scroll-view>

    <!-- 排序Tab -->
    <view class="sort-bar">
      <view class="sort-tab {{activeSort === index ? 'active' : ''}}"
            wx:for="{{sortTabs}}" wx:key="index"
            bindtap="onSortChange" data-index="{{index}}">
        <text>{{item}}</text>
        <view class="sort-line" wx:if="{{activeSort === index}}"></view>
      </view>
    </view>

    <!-- 商品瀑布流 -->
    <view class="product-grid">
      <view class="grid-column">
        <view class="product-card" wx:for="{{leftProducts}}" wx:key="id" bindtap="goDetail" data-id="{{item.id}}">
          <view class="card-image">
            <image src="{{item.images[0]}}" mode="aspectFill" class="product-img"></image>
            <view class="free-badge" wx:if="{{item.isFree}}">免费</view>
          </view>
          <view class="card-info">
            <text class="product-title line-clamp-2">{{item.title}}</text>
            <view class="price-row">
              <text class="price" wx:if="{{!item.isFree}}">¥{{item.price}}</text>
              <text class="price free-price" wx:else>免费自取</text>
              <text class="original-price" wx:if="{{item.originalPrice > 0 && !item.isFree}}">¥{{item.originalPrice}}</text>
            </view>
            <view class="card-footer">
              <text class="seller-info">{{item.building}}</text>
              <text class="want-count">{{item.wantCount}}人想要</text>
            </view>
          </view>
        </view>
      </view>
      <view class="grid-column">
        <view class="product-card" wx:for="{{rightProducts}}" wx:key="id" bindtap="goDetail" data-id="{{item.id}}">
          <view class="card-image">
            <image src="{{item.images[0]}}" mode="aspectFill" class="product-img"></image>
            <view class="free-badge" wx:if="{{item.isFree}}">免费</view>
          </view>
          <view class="card-info">
            <text class="product-title line-clamp-2">{{item.title}}</text>
            <view class="price-row">
              <text class="price" wx:if="{{!item.isFree}}">¥{{item.price}}</text>
              <text class="price free-price" wx:else>免费自取</text>
              <text class="original-price" wx:if="{{item.originalPrice > 0 && !item.isFree}}">¥{{item.originalPrice}}</text>
            </view>
            <view class="card-footer">
              <text class="seller-info">{{item.building}}</text>
              <text class="want-count">{{item.wantCount}}人想要</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="load-more" wx:if="{{!hasMore}}">— 没有更多了 —</view>
    <view style="height: 160rpx;"></view>
  </scroll-view>
</view>

<!-- 小区选择弹窗 -->
<view class="modal-mask" wx:if="{{showCommunityPicker}}" bindtap="closePicker">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">选择小区</text>
      <view class="modal-close" bindtap="closePicker">
        <icon name="x" size="36" color="#999"></icon>
      </view>
    </view>
    <view class="community-list">
      <view class="community-option {{item.name === currentCommunity ? 'selected' : ''}}"
            wx:for="{{communities}}" wx:key="id"
            bindtap="selectCommunity" data-item="{{item}}">
        <text>{{item.name}}</text>
        <icon wx:if="{{item.name === currentCommunity}}" name="check" size="32" color="#5B8C3E"></icon>
      </view>
    </view>
  </view>
</view>
